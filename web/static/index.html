<!DOCTYPE html>
<html>

<head>
    <title>Zohar Translate</title>
    <meta charset="UTF-8">
    <base href="/static/">

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <h1 class="title">Zohar Translate</h1>

    <div class="container">

        <span class="menu"><button id="copy" class="menu button">Copy Output</button></span>

        <span class="menu"><button id="save-as-table" class="menu button">Save as a Table</button></span>

        <span class="menu">
            <span class="microphone" disabled="true">🎙</span>
            <audio class="audio" controls="true" disabled="true"></audio>
        </span>

        <span class="menu">
            <button class="menu button" id="fileload-btn">Load from a File</button>
            <input type="file" id="load" />
        </span>

        <span class="menu">
            <button id="send-text-for-translation" class="menu button">Send Text</button>
        </span>

    </div>

    <div class="container">

        <span contenteditable="true" class="editable text" id="edited">
        </span>

        <span contenteditable="true" class="hebrew text" id="input">
        </span>

    </div>


    <div id="progress"><span></span></div>

    <script type="text/javascript" src="dictaphone.js"></script>
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript">
        const load = document.getElementById("load");
        const copy = document.getElementById("copy");

        const input = document.getElementById("input")
        const edited = document.getElementById("edited")

        function copyText(text) {
            /* Select the text field */
            const elem = document.createElement('textarea');
            elem.value = text;
            document.body.appendChild(elem);
            elem.select();
            document.execCommand('copy');
            document.body.removeChild(elem);
        }

        function send(file) {
            input.innerText = "";
            edited.innerText = "";
            // const size = file.size / 1000;
            // const seconds = size * 8;
            // const minutes = seconds / 60;
            // const show_minutes = minutes;
            // const show_seconds = seconds / 3;

            // if (minutes >= 1)
            //     alert("Translation will take approximately: " + show_minutes.toFixed(1) + " minutes.");
            // if (minutes < 1)
            //     alert("Translation will take approximately: " + show_seconds.toFixed(1) + " seconds.");

            var i = 0;
            var interval = setInterval(() => {
                showProgress(i);
                i++;
            }, 500)

            blockInput();

            fetch('/', {
                    method: 'PUT',
                    body: file
                })
                .then(response => {
                    unblockInput();
                    hideProgress();
                    clearInterval(interval);
                    return response.ok ? response.json() : {
                        "en": response.statusText,
                        "he": "שגיאה"
                    }
                })
                .then(texts => {
                    if ("en" in texts)
                        edited.innerText = texts["en"];
                    if ("he" in texts)
                        input.innerText = texts["he"];
                    edited.focus();
                })
                .catch(error => {
                    unblockInput();
                    hideProgress();
                    clearInterval(interval);
                    console.error('Error:', error);
                });
        }

        document.getElementById('fileload-btn')
        .addEventListener('click', (event) => {
            load.click();
        });

        load.addEventListener('change', (event) => {
            send(load.files[0]);
        });

        copy.addEventListener('click', (event) => {
            const text = document.querySelector('.editable');
            copyText(text.innerText);
        });
    </script>
</body>

</html>