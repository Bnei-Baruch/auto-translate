<!DOCTYPE html>
<html>

<head>
    <title>Zohar Translate</title>
    <meta charset="UTF-8">
    <base href="/static/">

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <h1 class="title">Zohar Translate</h1>

    <div class="container">

        <span class="menu"><button id="copy" class="menu button">Copy Output</button></span>

        <span class="menu"><button id="save-as-table" class="menu button">Save as a Table</button></span>

        <span class="menu">
            <span class="microphone" disabled="true">🎙</span>
            <audio class="audio" controls="true" disabled="true"></audio>
        </span>

        <span class="menu">
            <button class="menu button" id="fileload-btn">Load from a File</button>
            <input type="file" id="load" />
        </span>

        <span class="menu">
            <button id="send-text-for-translation" class="menu button">Send Text</button>
        </span>


    </div>

    <div class="container">

        <span contenteditable="true" class="editable text" id="edited">
        </span>

        <span contenteditable="true" class="hebrew text" id="input">
        </span>

    </div>

    <div class="progress-container">
        <div id="progress" class="progress">
            <div class="inner-progress"> <span></span></div>
        </div>
    </div>

    <div id="cpu" style="display: none">
        CPU: <span id="cpu-span"></span>
    </div>

    <script type="text/javascript" src="dictaphone.js"></script>
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="server-actions-mock.js"></script>

    <script type="text/javascript">
        const load = document.getElementById("load");
        const copy = document.getElementById("copy");

        const input = document.getElementById("input");
        const edited = document.getElementById("edited");
        const sendTextBtn = document.getElementById("send-text-for-translation");

        function copyText(text) {
            /* Select the text field */
            const elem = document.createElement('textarea');
            elem.value = text;
            document.body.appendChild(elem);
            elem.select();
            document.execCommand('copy');
            document.body.removeChild(elem);
        }

        function send(file, text) {
            input.innerText = "";
            edited.innerText = "";
            load.value = '';

            var i = 1;
            var interval = setInterval(() => {
                callProgressInPercents(null, i)
                    .then(response => {
                        console.error(response);
                        if (response.ok) {
                            var percent = +response.json().progress;
                            showProgress(percent);
                        } else {
                            console.error(response);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                i += 2;
            }, 500)

            blockInput();

            callFileProcessing(file)
                .then(response => {
                    unblockInput();
                    clearInterval(interval);
                    setTimeout(() => hideProgress(), 0);

                    return response.ok ? response.json() : {
                        "en": response.statusText,
                        "he": "שגיאה"
                    }
                })
                .then(texts => {
                    if ("en" in texts)
                        edited.innerText = texts["en"];
                    if ("he" in texts)
                        input.innerText = texts["he"];
                    edited.focus();
                })
                .catch(error => {
                    unblockInput();
                    clearInterval(interval);
                    setTimeout(() => hideProgress(), 0);
                    console.error('Error:', error);
                });
        }

        function sendText(text) {
            edited.innerText = "";

            var i = 1;
            var interval = setInterval(() => {
                callProgressInPercents(null, i)
                    .then(response => {
                        console.error(response);
                        if (response.ok) {
                            var percent = +response.json().progress;
                            showProgress(percent);
                        } else {
                            console.error(response);
                            showProgress(i);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                i += 2;
            }, 1000)

            blockInput();

            callTextProcessing(text)
                .then(response => {
                    unblockInput();
                    clearInterval(interval);
                    hideProgress();
                    return response.ok ? response.json() : {
                        "en": response.statusText,
                        "he": "שגיאה"
                    }
                })
                .then(texts => {
                    if ("en" in texts)
                        edited.innerText = texts["en"];
                    if ("he" in texts)
                        input.innerText = texts["he"];
                    edited.focus();
                })
                .catch(error => {
                    unblockInput();
                    clearInterval(interval);
                    hideProgress();
                    console.error('Error:', error);
                });
        }



        document.getElementById('fileload-btn')
            .addEventListener('click', (event) => {
                load.click();
            });

        load.addEventListener('change', (event) => {
            send(load.files[0]);
        });

        copy.addEventListener('click', (event) => {
            const text = document.querySelector('.editable');
            copyText(text.innerText);
        });

        sendTextBtn.addEventListener('click', (event) => {
            const text = input.textContent;
            sendText(text);
        });

        setInterval(() => {
            callCPUUsageInPercents()
                .then(response => {
                    if (response.ok) {
                        var percent = +response.json().cpu;
                        setCPU(percent);
                    } else {
                        console.error(response);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }, 1000)
    </script>
</body>

</html>