<!DOCTYPE html>
<html>

<head>
    <title>Zohar Translate</title>
    <meta charset="UTF-8">
    <base href="/static/">

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <h1 class="title">Zohar Translate</h1>

    <div class="container">

        <span class="menu">
            <button class="menu button" id="fileload-btn">Load from a File</button>
            <input type="file" id="load" />
        </span>

        <span class="menu">
            <button id="send-text-for-translation" class="menu button">Send Text</button>
        </span>

        <span class="menu">
            <span class="microphone" disabled="true">🎙</span>
            <audio class="audio" controls="true" disabled="true"></audio>
        </span>

        <span class="menu"><button id="copy" class="menu button">Copy Output</button></span>

        <span class="menu"><button id="save-as-table" class="menu button">Save as a Table</button></span>


    </div>

    <div class="container model-select">
        <div class="select-container">

            <div class="inline-select">
                <div>Source</div>
                <select id="select-src-lg"> </select>
            </div>

            <div class="inline-select">
                <div>Destination</div>
                <select id="select-dest-lg"> </select>
            </div>

            <div class="inline-select">
                <div>Style</div>
                <select id="select-style"> </select>
            </div>

            <div class="inline-select">
                <div>Version</div>
                <select id="select-version"> </select>
            </div>

            <div class="inline-select">
                <div>Date</div>
                <select id="select-date">
                    <option value="nov-5-20" selected>nov-5-20</option>
                </select>
            </div>

        </div>
    </div>

    <div class="container">
        <textarea class="hebrew text" id="input" ></textarea>
        <span class="arrow">➪</span>
        <textarea class="editable text" id="edited"></textarea>
    </div>

    <div class="progress-container">
        <div id="progress" class="progress">
            <div class="inner-progress"> <span></span></div>
        </div>
    </div>

    <div id="cpu" style="display: none">
        CPU: <span id="cpu-span"></span>
    </div>

    <!-- order is vital here! -->
    <script type="text/javascript" src="dictaphone.js"></script>
    <script type="text/javascript" src="utils.js"></script>
    <!-- <script type="text/javascript" src="server-actions-mock.js"></script> -->
    <script type="text/javascript" src="server-actions.js"></script>
    <script type="text/javascript" src="default-actions.js"></script>

    <script type="text/javascript">
        const load = document.getElementById("load");
        const copy = document.getElementById("copy");

        const input = document.getElementById("input");
        const edited = document.getElementById("edited");
        const sendTextBtn = document.getElementById("send-text-for-translation");

        function copyText(text) {
            /* Select the text field */
            const elem = document.createElement('textarea');
            elem.value = text;
            document.body.appendChild(elem);
            elem.select();
            document.execCommand('copy');
            document.body.removeChild(elem);
        }

        function setupProgressInterval(timestamp) {
            var i = 1;
            var interval = setInterval(() => {
                callProgressInPercents(timestamp, i)
                    .then(response => response.json())
                    .then(response => {
                        var percent = +response.progress;
                        showProgress(percent);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                i += 2;
            }, 1 * 1000)

            return interval;
        }

        function send(file) {
            input.innerText = "";
            edited.innerText = "";
            load.value = '';

            var timestamp = getTimestamp();
            var model = getSelectedTranslateModel();

            callFileProcessing(file, timestamp, model)
                .then(response => {
                    unblockInput();
                    clearInterval(interval);
                    setTimeout(() => hideProgress(), 0);

                    return response.ok ? response.json() : {
                        "en": response.statusText,
                        "he": "שגיאה"
                    }
                })
                .then(texts => {

                    console.log(texts);

                    if ("en" in texts){
                        edited.innerText = texts["en"];
                        edited.dispatchEvent(new Event('input', { bubbles: false }));
                    }
                    
                    if ("he" in texts){
                        input.innerText = texts["he"];
                        input.dispatchEvent(new Event('input', { bubbles: false }));
                    }
                        
                    edited.focus();
                })
                .catch(error => {
                    unblockInput();
                    clearInterval(interval);
                    setTimeout(() => hideProgress(), 0);
                    console.error('Error:', error);
                });

            blockInput();
            var interval = setupProgressInterval(timestamp);
        }

        function sendText(text) {
            edited.innerText = "";

            var timestamp = getTimestamp();
            var model = getSelectedTranslateModel();

            callTextProcessing(text, timestamp, model)
                .then(response => {
                    unblockInput();
                    clearInterval(interval);
                    hideProgress();
                    return response.ok ? response.json() : {
                        translatedText: response.statusText,
                        sourceText: "שגיאה"
                    }
                })
                .then(texts => {
                    edited.innerText = texts.translatedText;
                    edited.dispatchEvent(new Event('input', { bubbles: false }));
                    edited.focus();

                    input.innerText = texts.sourceText;
                    input.dispatchEvent(new Event('input', { bubbles: false }));
                })
                .catch(error => {
                    unblockInput();
                    clearInterval(interval);
                    hideProgress();
                    console.error('Error:', error);
                });

            blockInput();
            var interval = setupProgressInterval(timestamp);
        }

        document.getElementById('fileload-btn')
            .addEventListener('click', (event) => {
                load.click();
            });

        load.addEventListener('change', (event) => {
            send(load.files[0]);
        });

        copy.addEventListener('click', (event) => {
            const text = document.querySelector('.editable');
            copyText(text.innerText);
        });

        var selects = document.querySelectorAll('.select-container .inline-select select');
        selects.forEach(element => {
            element.addEventListener('change', (e) => {
                modelSelectChanged();
            });
        });

        var textareas = document.querySelectorAll('textarea');
        textareas.forEach(element => {
            element.addEventListener('input', (e) => {
                auto_grow(element);
            });
        });


        sendTextBtn.addEventListener('click', (event) => {
            const text = input.textContent;
            sendText(text);
        });

        
    </script>
</body>

</html>